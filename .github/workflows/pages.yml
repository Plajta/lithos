name: Deploy Next.js site to Pages

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout ðŸ›Žï¸
              uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  run_install: false

            - name: Setup Node ðŸŸ¢
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "pnpm"

            - name: Install dependencies ðŸ“¦
              run: pnpm install

            - name: Build with Next.js ðŸ”§
              run: pnpm run build
              env:
                  NEXT_PUBLIC_BASE_PATH: ${{ github.ref == 'refs/heads/dev' && '/dev' || '' }}

            - name: Add .nojekyll to Build Output ðŸ“‚
              run: touch out/.nojekyll

            - name: Create CNAME
              if: github.ref == 'refs/heads/main'
              run: echo "lithos.plajta.eu" > out/CNAME

            - name: Deploy Main ðŸš€
              if: github.ref == 'refs/heads/main'
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  branch: gh-pages
                  folder: out
                  target-folder: .
                  clean: true
                  clean-exclude: dev

            - name: Deploy Dev ðŸš€
              if: github.ref == 'refs/heads/dev'
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  branch: gh-pages
                  folder: out
                  target-folder: dev
                  clean: true
